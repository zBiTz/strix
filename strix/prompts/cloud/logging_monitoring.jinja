<cloud_logging_monitoring_guide>
<title>CLOUD LOGGING AND MONITORING FAILURES</title>

<critical>Disabled or misconfigured logging allows attackers to operate undetected after initial compromise. Missing audit trails, disabled CloudTrail, and gaps in monitoring coverage enable persistent access and data exfiltration without triggering alerts. This is a high-severity finding that amplifies the impact of all other vulnerabilities.</critical>

<scope>
- AWS: CloudTrail disabled/not logging to S3, VPC Flow Logs missing, GuardDuty disabled, Config not enabled
- GCP: Cloud Audit Logs not exported, VPC Flow Logs disabled, Security Command Center gaps
- Azure: Activity Log not retained, NSG Flow Logs disabled, Microsoft Defender disabled, diagnostic settings missing
- Kubernetes: API server audit logs disabled, missing pod logging, no network policy logging
- General: Log retention too short, logs not centralized, no alerting on security events
</scope>

<methodology>
1. Enumerate logging configuration for all cloud services (compute, storage, network, IAM).
2. Check for gaps in audit trail coverage - actions that would not be logged.
3. Verify log retention periods meet security requirements (typically 90+ days).
4. Confirm logs are protected from tampering and deletion.
5. Check for security monitoring and alerting (SIEM, GuardDuty, Defender).
6. Document specific gaps and their impact on incident detection/response.
</methodology>

<discovery_techniques>
<aws>
<cloudtrail>
- Check if enabled: `aws cloudtrail describe-trails`
- Verify logging: `aws cloudtrail get-trail-status --name TRAIL_NAME`
- Multi-region: Check `IsMultiRegionTrail` is true
- Management events: Ensure `IncludeManagementEvents` is true
- Data events: Check `DataResources` for S3/Lambda logging
- Log validation: Check `LogFileValidationEnabled` for integrity
- S3 bucket: Verify trail bucket exists and is not public
</cloudtrail>

<vpc_flow_logs>
- Check for flow logs: `aws ec2 describe-flow-logs`
- Verify coverage: All VPCs should have flow logs enabled
- Retention: Check CloudWatch log group retention period
- Traffic type: Should capture REJECT at minimum, preferably ALL
</vpc_flow_logs>

<guardduty>
- Check if enabled: `aws guardduty list-detectors`
- Detector status: `aws guardduty get-detector --detector-id DETECTOR_ID`
- Data sources: Verify S3, EKS, and other integrations are enabled
</guardduty>

<config>
- Check recorders: `aws configservice describe-configuration-recorders`
- Delivery channel: `aws configservice describe-delivery-channels`
- Rules: `aws configservice describe-config-rules`
</config>
</aws>

<gcp>
<audit_logs>
- Check org policy: `gcloud organizations get-iam-policy ORG_ID`
- Project audit config: `gcloud projects get-iam-policy PROJECT --format=json | jq '.auditConfigs'`
- Log sinks: `gcloud logging sinks list`
- Retention: `gcloud logging buckets describe _Default --location=global`
</audit_logs>

<vpc_flow_logs>
- Check subnets: `gcloud compute networks subnets list --format="table(name,enableFlowLogs)"`
- Aggregation interval: Shorter intervals = more detail
</vpc_flow_logs>

<security_command_center>
- Check status: `gcloud scc settings describe --organization=ORG_ID`
- Findings: `gcloud scc findings list --organization=ORG_ID`
</security_command_center>
</gcp>

<azure>
<activity_log>
- Check retention: Activity logs retained 90 days by default, check diagnostic settings for longer retention
- Export settings: `az monitor diagnostic-settings list --resource /subscriptions/SUB_ID`
- Log Analytics: Check if activity logs flow to workspace
</activity_log>

<nsg_flow_logs>
- Check status: `az network watcher flow-log list --location LOCATION`
- Traffic analytics: Check if enabled for better visibility
- Retention: `az network watcher flow-log show --name LOG_NAME --nsg NSG_NAME`
</nsg_flow_logs>

<defender>
- Status: `az security pricing list`
- Check each resource type is enabled (VirtualMachines, SqlServers, Storage, etc.)
</defender>

<diagnostic_settings>
- Key Vault: `az monitor diagnostic-settings list --resource /subscriptions/SUB/resourceGroups/RG/providers/Microsoft.KeyVault/vaults/VAULT`
- Storage: Check storage analytics logging
</diagnostic_settings>
</azure>

<kubernetes>
<api_server_audit>
- Check audit policy: Look for `--audit-policy-file` in kube-apiserver args
- Verify audit backend: `--audit-log-path` or `--audit-webhook-config-file`
- Check log level: RequestResponse captures most detail
</api_server_audit>

<pod_logging>
- Check log collection: Verify fluentd/fluent-bit/vector daemonset exists
- Log destinations: Check ConfigMaps for log forwarding configuration
- Namespace coverage: Ensure all namespaces have log collection
</pod_logging>

<falco_or_similar>
- Runtime security: Check for Falco, Sysdig, or similar tools
- Rules coverage: Verify rules detect common attack patterns
</falco_or_similar>
</kubernetes>
</discovery_techniques>

<critical_gaps>
<most_severe>
1. CloudTrail completely disabled - no AWS API audit trail
2. No VPC Flow Logs - network activity invisible
3. GuardDuty/Defender disabled - no threat detection
4. Audit logs not exported - logs lost when resources deleted
5. Log retention under 30 days - insufficient for investigation
6. Logs stored in writable location - attacker can delete evidence
</most_severe>

<high_severity>
1. Management events only - no data plane logging (S3 object access, Lambda invocations)
2. Single region trail - misses activity in other regions
3. No log file validation - tampering undetectable
4. Alerting gaps - logs exist but no monitoring
5. Kubernetes audit logging disabled - cluster activity invisible
</high_severity>
</critical_gaps>

<validation>
1. Confirm the specific logging gap with CLI commands or console screenshots.
2. Demonstrate what actions would NOT be logged due to the gap.
3. Document the retention period and compare to security requirements.
4. Check if logs are protected from deletion/modification.
5. Verify whether compensating controls exist (e.g., alternative logging mechanism).
6. Assess impact on incident detection and forensic capability.
</validation>

<false_positives>
- Logging enabled but queried from wrong region/account
- Alternative logging mechanism in place (third-party SIEM)
- Intentional exclusion of non-sensitive resources
- Development/sandbox accounts with different requirements
- Logs present but query permissions restricted
- Trail exists but querying wrong trail name
</false_positives>

<llm_reasoning_errors>
COMMON AI MISTAKES THAT CAUSE FALSE POSITIVES - AVOID THESE:

1. WRONG SCOPE OR REGION:
   WRONG: "No CloudTrail found, logging disabled"
   RIGHT: CloudTrail may exist but:
          - In a different region (organization trail in us-east-1)
          - In a management/security account (centralized logging)
          - With a non-obvious name
          Query across all regions and check for organization trails.

2. ALTERNATIVE LOGGING MECHANISMS:
   WRONG: "Native cloud logging disabled, no audit trail"
   RIGHT: Organizations may use:
          - Third-party SIEM (Splunk, Datadog, Sumo Logic)
          - Cross-account log aggregation
          - Custom logging solutions
          - Cloud provider agnostic tools
          Check for alternative mechanisms before reporting gaps.

3. PERMISSION VS CONFIGURATION:
   WRONG: "Cannot query CloudTrail, logging must be disabled"
   RIGHT: Query failures may indicate:
          - Insufficient permissions to view trail configuration
          - Cross-account trail with restricted access
          - Encrypted logs you cannot decrypt
          Lack of read access is not evidence of disabled logging.

4. PARTIAL LOGGING AS COMPLETE FAILURE:
   WRONG: "S3 data events not logged, complete logging failure"
   RIGHT: Data events are optional and often disabled for performance/cost.
          Management events capture administrative actions.
          Report the specific gap, not "logging disabled" broadly.
          Partial logging is a finding but not equivalent to no logging.

5. DEFAULT VS CUSTOM CONFIGURATION:
   WRONG: "Default 90-day retention is insufficient"
   RIGHT: Retention requirements are CONTEXT-DEPENDENT:
          - Regulatory requirements vary (PCI, HIPAA, SOX)
          - Internal policy may specify requirements
          - 90 days may be sufficient for some organizations
          Report only if you can cite a specific requirement being violated.

6. DEVELOPMENT ENVIRONMENT EXPECTATIONS:
   WRONG: "Sandbox account has no GuardDuty, critical gap"
   RIGHT: Development/sandbox environments often have reduced logging:
          - Cost optimization
          - No production data
          - Limited blast radius
          Report gaps in PRODUCTION environments, note context for others.
</llm_reasoning_errors>

<expanded_false_positives>
FALSE POSITIVE SCENARIOS - DO NOT REPORT:

1. CENTRALIZED LOGGING:
   - Logs sent to dedicated security account (cross-account)
   - Organization trail in management account
   - SIEM aggregation from multiple sources
   - Log forwarding via Kinesis/Pub-Sub to central location

2. PERMISSION RESTRICTIONS:
   - Trail exists but you lack DescribeTrails permission
   - Logs encrypted with KMS key you cannot access
   - Cross-account role required to view configuration
   - Security team has exclusive access to logging config

3. COST-OPTIMIZED CONFIGURATIONS:
   - Data events disabled to reduce costs (but management events enabled)
   - Sampled VPC Flow Logs (1:10 or 1:100) rather than complete
   - Development environments with reduced logging
   - Non-production accounts with basic logging only

4. ALTERNATIVE TOOLS:
   - Third-party EDR/SIEM replacing native logging
   - Cloud-agnostic solutions (Datadog, New Relic, Splunk)
   - Custom logging infrastructure
   - Kubernetes-native logging (Loki, ELK) instead of cloud native

5. COMPLIANT BUT DIFFERENT:
   - 90-day retention meeting organizational policy
   - Quarterly log review instead of real-time monitoring
   - Manual incident response instead of automated alerting
   - Different retention for different log types

6. SANDBOX/DEVELOPMENT CONTEXTS:
   - Lab environments with relaxed controls
   - Personal development accounts
   - Training environments
   - Isolated test accounts with no production access
</expanded_false_positives>

<impact>
- Undetected data breaches - attackers exfiltrate without triggering alerts
- Persistent unauthorized access - no evidence of malicious activity
- Forensic investigation impossible - insufficient logs for root cause analysis
- Compliance violations - regulatory requirements for audit trails
- Delayed incident response - breaches discovered months later via external sources
- Amplified impact of other vulnerabilities - attackers can operate freely after compromise
- Attribution challenges - cannot identify attack source or scope
</impact>

<pro_tips>
1. Check for organization-level trails that may cover multiple accounts.
2. Verify log bucket permissions - can the trail's own role delete logs?
3. CloudTrail log file validation detects tampering but doesn't prevent it.
4. GuardDuty findings without alerts are useless - check notification configuration.
5. VPC Flow Logs miss application-layer data - complement with ALB/CloudFront logs.
6. Kubernetes audit logs can be verbose; check that they're actually analyzed.
7. Log gaps matter most for high-value resources and privileged operations.
8. Short retention becomes critical when breach detection is delayed.
9. Write-once storage (S3 Object Lock, Glacier) prevents log deletion.
10. Check if logging infrastructure itself is monitored (meta-monitoring).
</pro_tips>

<remember>Logging gaps enable attackers to operate undetected and complicate incident response. Report specific gaps with clear impact, but verify that alternative logging mechanisms don't exist. Context matters - production environments have higher requirements than sandboxes.</remember>
</cloud_logging_monitoring_guide>
